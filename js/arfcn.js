//=================================================================================================
//
//  File: arfcn.js
//
//  Description:  Support file which contains all functionality to convert between freq and UARFCN and EARFCN.
//      Copied from xARFCNconvert.cpp.
//     
//          Converted 'C' structures to JSON structures to allow javascript indexing.
//
//     Global call:  ConvertFreqToArfcn( tech, band, freq_t100kHz)
//
//=================================================================================================

const   TECH_WCDMA_FLAG     = 0;
const   TECH_LTE_FLAG       = 1;
const   FREQDELTA           = 0.01;

// Table 5.1 from 3GPP 25.101
//typedef struct
//{
//    unsigned char Band;
//    double Fdl_offset;
//    double Fdl_low;
//    double Fdl_high;
//} s3GPP25101Tab51;
    
// Global file variables.......................................................
const umts =
[
    /*Additional channels*/
    { "bd":2, "of":1850.1,  "lo":1932.5, "hi":1932.5 },
    { "bd":2, "of":1850.1,  "lo":1937.5, "hi":1937.5 },
    { "bd":2, "of":1850.1,  "lo":1942.5, "hi":1942.5 },
    { "bd":2, "of":1850.1,  "lo":1947.5, "hi":1947.5 },
    { "bd":2, "of":1850.1,  "lo":1952.5, "hi":1952.5 },
    { "bd":2, "of":1850.1,  "lo":1957.5, "hi":1957.5 },
    { "bd":2, "of":1850.1,  "lo":1962.5, "hi":1962.5 },
    { "bd":2, "of":1850.1,  "lo":1967.5, "hi":1967.5 },
    { "bd":2, "of":1850.1,  "lo":1972.5, "hi":1972.5 },
    { "bd":2, "of":1850.1,  "lo":1977.5, "hi":1977.5 },
    { "bd":2, "of":1850.1,  "lo":1982.5, "hi":1982.5 },
    { "bd":2, "of":1850.1,  "lo":1987.5, "hi":1987.5 },
    { "bd":4, "of":1735.1,  "lo":2112.5, "hi":2112.5 },
    { "bd":4, "of":1735.1,  "lo":2117.5, "hi":2117.5 },
    { "bd":4, "of":1735.1,  "lo":2122.5, "hi":2122.5 },
    { "bd":4, "of":1735.1,  "lo":2127.5, "hi":2127.5 },
    { "bd":4, "of":1735.1,  "lo":2132.5, "hi":2132.5 },
    { "bd":4, "of":1735.1,  "lo":2137.5, "hi":2137.5 },
    { "bd":4, "of":1735.1,  "lo":2142.5, "hi":2142.5 },
    { "bd":4, "of":1735.1,  "lo":2147.5, "hi":2147.5 },
    { "bd":4, "of":1735.1,  "lo":2152.5, "hi":2152.5 },
    { "bd":5, "of":670.1,   "lo":871.5,  "hi":871.5 },
    { "bd":5, "of":670.1,   "lo":872.5,  "hi":872.5 },
    { "bd":5, "of":670.1,   "lo":876.5,  "hi":876.5 },
    { "bd":5, "of":670.1,   "lo":877.5,  "hi":877.5 },
    { "bd":5, "of":670.1,   "lo":882.5,  "hi":882.5 },
    { "bd":5, "of":670.1,   "lo":887.5,  "hi":887.5 },
    { "bd":6, "of":670.1,   "lo":877.5,  "hi":877.5 },
    { "bd":6, "of":670.1,   "lo":882.5,  "hi":882.5 },
    { "bd":7, "of":2105.1,  "lo":2622.5, "hi":2622.5 },
    { "bd":7, "of":2105.1,  "lo":2627.5, "hi":2627.5 },
    { "bd":7, "of":2105.1,  "lo":2632.5, "hi":2632.5 },
    { "bd":7, "of":2105.1,  "lo":2637.5, "hi":2637.5 },
    { "bd":7, "of":2105.1,  "lo":2642.5, "hi":2642.5 },
    { "bd":7, "of":2105.1,  "lo":2647.5, "hi":2647.5 },
    { "bd":7, "of":2105.1,  "lo":2652.5, "hi":2652.5 },
    { "bd":7, "of":2105.1,  "lo":2657.5, "hi":2657.5 },
    { "bd":7, "of":2105.1,  "lo":2662.5, "hi":2662.5 },
    { "bd":7, "of":2105.1,  "lo":2667.5, "hi":2667.5 },
    { "bd":7, "of":2105.1,  "lo":2672.5, "hi":2672.5 },
    { "bd":7, "of":2105.1,  "lo":2677.5, "hi":2677.5 },
    { "bd":7, "of":2105.1,  "lo":2682.5, "hi":2682.5 },
    { "bd":7, "of":2105.1,  "lo":2687.5, "hi":2687.5 },
    { "bd":10, "of":1430.1, "lo":2112.5, "hi":2112.5 },
    { "bd":10, "of":1430.1, "lo":2117.5, "hi":2117.5 },
    { "bd":10, "of":1430.1, "lo":2122.5, "hi":2122.5 },
    { "bd":10, "of":1430.1, "lo":2127.5, "hi":2127.5 },
    { "bd":10, "of":1430.1, "lo":2132.5, "hi":2132.5 },
    { "bd":10, "of":1430.1, "lo":2137.5, "hi":2137.5 },
    { "bd":10, "of":1430.1, "lo":2142.5, "hi":2142.5 },
    { "bd":10, "of":1430.1, "lo":2147.5, "hi":2147.5 },
    { "bd":10, "of":1430.1, "lo":2152.5, "hi":2152.5 },
    { "bd":10, "of":1430.1, "lo":2157.5, "hi":2157.5 },
    { "bd":10, "of":1430.1, "lo":2162.5, "hi":2162.5 },
    { "bd":10, "of":1430.1, "lo":2167.5, "hi":2167.5 },
    { "bd":12, "of":-54.9,  "lo":731.5,  "hi":731.5 },
    { "bd":12, "of":-54.9,  "lo":736.5,  "hi":736.5 },
    { "bd":12, "of":-54.9,  "lo":737.5,  "hi":737.5 },
    { "bd":12, "of":-54.9,  "lo":742.5,  "hi":742.5 },
    { "bd":12, "of":-54.9,  "lo":743.5,  "hi":743.5 },
    { "bd":13, "of":-64.9,  "lo":748.5,  "hi":748.5 },
    { "bd":13, "of":-64.9,  "lo":753.5,  "hi":753.5 },
    { "bd":14, "of":-72.9,  "lo":760.5,  "hi":760.5 },
    { "bd":14, "of":-72.9,  "lo":765.5,  "hi":765.5 },
    { "bd":19, "of":720.1,  "lo":877.5,  "hi":877.5 },
    { "bd":19, "of":720.1,  "lo":882.5,  "hi":882.5 },
    { "bd":19, "of":720.1,  "lo":887.5,  "hi":887.5 },
    { "bd":25, "of":674.1,  "lo":1932.5, "hi":1932.5 },
    { "bd":25, "of":674.1,  "lo":1937.5, "hi":1937.5 },
    { "bd":25, "of":674.1,  "lo":1942.5, "hi":1942.5 },
    { "bd":25, "of":674.1,  "lo":1947.5, "hi":1947.5 },
    { "bd":25, "of":674.1,  "lo":1952.5, "hi":1952.5 },
    { "bd":25, "of":674.1,  "lo":1957.5, "hi":1957.5 },
    { "bd":25, "of":674.1,  "lo":1962.5, "hi":1962.5 },
    { "bd":25, "of":674.1,  "lo":1967.5, "hi":1967.5 },
    { "bd":25, "of":674.1,  "lo":1972.5, "hi":1972.5 },
    { "bd":25, "of":674.1,  "lo":1977.5, "hi":1977.5 },
    { "bd":25, "of":674.1,  "lo":1992.5, "hi":1992.5 },
    { "bd":25, "of":674.1,  "lo":1982.5, "hi":1982.5 },
    { "bd":25, "of":674.1,  "lo":1987.5, "hi":1987.5 },
    { "bd":26, "of":-325.9, "lo":861.5,  "hi":861.5 },
    { "bd":26, "of":-325.9, "lo":866.5,  "hi":866.5 },
    { "bd":26, "of":-325.9, "lo":871.5,  "hi":871.5 },
    { "bd":26, "of":-325.9, "lo":872.5,  "hi":872.5 },
    { "bd":26, "of":-325.9, "lo":876.5,  "hi":876.5 },
    { "bd":26, "of":-325.9, "lo":877.5,  "hi":877.5 },
    { "bd":26, "of":-325.9, "lo":881.5,  "hi":881.5 },
    { "bd":26, "of":-325.9, "lo":882.5,  "hi":882.5 },
    { "bd":26, "of":-325.9, "lo":886.5,  "hi":886.5 },
    { "bd":26, "of":-325.9, "lo":887.5,  "hi":887.5 },
    { "bd":26, "of":-325.9, "lo":891.5,  "hi":891.5 },
    
    /*General channels*/
    { "bd":1, "of":0,       "lo":2112.4, "hi":2167.6 },
    { "bd":2, "of":0,       "lo":1932.4, "hi":1987.6 },
    { "bd":3, "of":1575,    "lo":1807.4, "hi":1877.6 },
    { "bd":4, "of":1805,    "lo":2112.4, "hi":2152.6 },
    { "bd":5, "of":0,       "lo":871.4,  "hi":891.6 },
    { "bd":6, "of":0,       "lo":877.4,  "hi":882.6 },
    { "bd":7, "of":2175,    "lo":2622.4, "hi":2687.6 },
    { "bd":8, "of":340,     "lo":927.4,  "hi":957.6},
    { "bd":9, "of":0,       "lo":1847.4, "hi":1877.4 },
    { "bd":10, "of":1490,   "lo":2112.4, "hi":2167.6 },
    { "bd":11, "of":736,    "lo":1478.4, "hi":1493.4 },
    { "bd":12, "of":-37,    "lo":731.4,  "hi":743.6 },
    { "bd":13, "of":-55,    "lo":748.4,  "hi":753.6 },
    { "bd":14, "of":-63,    "lo":760.4,  "hi":765.6 },
    { "bd":19, "of":735,    "lo":877.4,  "hi":887.6 },
    { "bd":20, "of":-109,   "lo":793.4,  "hi":818.6 },
    { "bd":21, "of":1326,   "lo":1498.4, "hi":1508.4 },
    { "bd":22, "of":2580,   "lo":3512.4, "hi":3587.6 },
    { "bd":25, "of":910,    "lo":1932.4, "hi":1992.6 },
    { "bd":26, "of":-291,   "lo":861.4,  "hi":891.6 }
];

////////////////////////////////////////////
// Table 5.7.3 from 3GPP 36.101
//typedef struct
//{
//    unsigned char bd;
//    double Fdl_low;
//    double Noffs_dl;
//    double Ndl_low;
//    double Ndl_high;
//} s3GPP36101Tab57;

const lte =
[
    { "bd":1,  "fl":2110,   "dl":0,     "lo":0,     "hi":599 },
    { "bd":2,  "fl":1930,   "dl":600,   "lo":600,   "hi":1199 },
    { "bd":3,  "fl":1805,   "dl":1200,  "lo":1200,  "hi":1949 },
    { "bd":4,  "fl":2110,   "dl":1950,  "lo":1950,  "hi":2399 },
    { "bd":5,  "fl":869,    "dl":2400,  "lo":2400,  "hi":2649 },
    { "bd":6,  "fl":875,    "dl":2650,  "lo":2650,  "hi":2749 },
    { "bd":7,  "fl":2620,   "dl":2750,  "lo":2750,  "hi":3449 },
    { "bd":8,  "fl":925,    "dl":3450,  "lo":3450,  "hi":3799 },
    { "bd":9,  "fl":1844.9, "dl":3800,  "lo":3800,  "hi":4149 },
    { "bd":10, "fl":2110,   "dl":4150,  "lo":4150,  "hi":4749 },
    { "bd":11, "fl":1475.9, "dl":4750,  "lo":4750,  "hi":4949 },
    { "bd":12, "fl":729,    "dl":5010,  "lo":5010,  "hi":5179 },
    { "bd":13, "fl":746,    "dl":5180,  "lo":5180,  "hi":5279 },
    { "bd":14, "fl":758,    "dl":5280,  "lo":5280,  "hi":5379 },
    { "bd":17, "fl":734,    "dl":5730,  "lo":5730,  "hi":5849 },
    { "bd":18, "fl":860,    "dl":5850,  "lo":5850,  "hi":5999 },
    { "bd":19, "fl":875,    "dl":6000,  "lo":6000,  "hi":6149 },
    { "bd":20, "fl":791,    "dl":6150,  "lo":6150,  "hi":6449 },
    { "bd":21, "fl":1495.9, "dl":6450,  "lo":6450,  "hi":6599 },
    { "bd":22, "fl":3510,   "dl":6600,  "lo":6600,  "hi":7399 },
    { "bd":23, "fl":2180,   "dl":7500,  "lo":7500,  "hi":7699 },
    { "bd":24, "fl":1525,   "dl":7700,  "lo":7700,  "hi":8039 },
    { "bd":25, "fl":1930,   "dl":8040,  "lo":8040,  "hi":8689 },
    { "bd":26, "fl":859,    "dl":8690,  "lo":8690,  "hi":9039 },
    { "bd":27, "fl":852,    "dl":9040,  "lo":9040,  "hi":9209 },
    { "bd":28, "fl":758,    "dl":9210,  "lo":9210,  "hi":9659 },
    { "bd":29, "fl":717,    "dl":9660,  "lo":9660,  "hi":9769 },
    { "bd":30, "fl":2350,   "dl":9770,  "lo":9770,  "hi":9869 },
    { "bd":31, "fl":462.5,  "dl":9870,  "lo":9870,  "hi":9919 },
    { "bd":33, "fl":1900,   "dl":36000, "lo":36000, "hi":36199 },
    { "bd":34, "fl":2010,   "dl":36200, "lo":36200, "hi":36349 },
    { "bd":35, "fl":1850,   "dl":36350, "lo":36350, "hi":36949 },
    { "bd":36, "fl":1930,   "dl":36950, "lo":36950, "hi":37549 },
    { "bd":37, "fl":1910,   "dl":37550, "lo":37550, "hi":37749 },
    { "bd":38, "fl":2570,   "dl":37750, "lo":37750, "hi":38249 },
    { "bd":39, "fl":1880,   "dl":38250, "lo":38250, "hi":38649 },
    { "bd":40, "fl":2300,   "dl":38650, "lo":38650, "hi":39649 },
    { "bd":41, "fl":2496,   "dl":39650, "lo":39650, "hi":41589 },
    { "bd":42, "fl":3400,   "dl":41590, "lo":41590, "hi":43589 },
    { "bd":43, "fl":3600,   "dl":43590, "lo":43590, "hi":45589 },
    { "bd":44, "fl":703,    "dl":45590, "lo":45590, "hi":46589 }
];




// Global File System calls .....................................................................................
function ConvertFreqToArfcn( tech, band, freq_t100kHz)
{

    var freq   = freq_t100kHz;
    var uarfcn = 0;

    if( tech == TECH_WCDMA_FLAG )
    {
        var Nd         = 0;
        var Fdl        = freq;
        var Fdl_offset = 0;
        var Fdl_low    = 0;
        var Fdl_high   = 0;   // Nd = 5 * (Fdl - Fdl_offset) where Fdl_low <= Fdl <= Fdl_high

        for( var I = 0; I < umts.length; I++ )
        {
            if( umts[I].bd == band )
            {
                Fdl_offset = 10 * umts[I].of;
                Fdl_low    = 10 * (umts[I].lo - FREQDELTA);
                Fdl_high   = 10 * (umts[I].hi + FREQDELTA);
                if( (Fdl_low <= Fdl) && (Fdl <= Fdl_high) )
                {
                    Nd = (Fdl - Fdl_offset)/2;
                    uarfcn = Math.floor(Nd);
                    break;
                }
            }
        }
        //LOG_ENTRY("UMTS band %d : freq=%f ==> UARFCN=%d", band, freq, uarfcn);
    }
    else
    {
        var Fdl      = freq;
        var Fdl_low  = 0;
        var Ndl      = 0;
        var Noffs_dl = 0;
        var Ndl_low  = 0;
        var Ndl_high = 0; // Fdl = Fdl_low + 0.1*(Ndl - Noffs_dl) where Ndl_low <= Ndl <= Ndl_high

        for( var I = 0; I < lte.length; I++ )
        {
            if( lte[I].bd == band )
            {
                Fdl_low  = 10 * lte[I].fl;
                Noffs_dl = lte[I].dl;
                Ndl_low  = lte[I].lo;
                Ndl_high = lte[I].hi;
                Ndl = (Fdl - Fdl_low) + Noffs_dl;
                if( (Ndl_low <= Ndl) && (Ndl <= Ndl_high) )
                {
                    uarfcn = Math.floor(Ndl);
                    break;
                }
            }
        }
        //LOG_ENTRY("LTE band %d : freq=%f ==> EARFCN=%d", band, freq, uarfcn);
    }

    if( tech == TECH_WCDMA_FLAG )
    {
        PrintLog(1, "ConvertFreqToArfcn( WCDMA, Band=" + band + ", 100kfreq=" + freq + ") = " + uarfcn );
    }
    else
    {
        PrintLog(1, "ConvertFreqToArfcn( LTE, Band=" + band + ", 100kfreq=" + freq + ") = " + uarfcn );
    }
    

    return uarfcn;

}





